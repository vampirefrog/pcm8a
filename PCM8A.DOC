┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃									┃
┃	リアルタイム　ＡＤＰＣＭ多重再生ドライバー　『ＰＣＭ８Ａ』	┃
┃									┃
┃		version 1.02			philly 1993-1997	┃
┃									┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛

　　PCM8.X (c)H.Etoh （以下 PCM8 と略します）相当のプログラムに
　　MPCM.X (c)wachoman （以下 MPCM と略します）相当の機能を追加したプログ
　ラムです


▲基本機能

　１）Ｘ６８０ｘ０のＡＤＰＣＭ出力を、複数の出力がリアルタイムでできるよう
　　　にする常駐型ドライバーです

　２）１０ＭＨｚの機種でも８チャンネル同時出力が可能です
　　　（モードによっては、８チャンネルを出力できないことがあります）

　３）チャンネル毎に音程および音量を自在に指定することができます
　　　（ＭＰＣＭモード時）

▲ PCM8（ version 0.48/0.48a/0.48b ）及び MPCM とは以下の差異があります

　１）ＡＤＰＣＭ出力時、少し高速になっています
　　　欠点：多少音質が低下しています（高速化の弊害です）

　２）ＡＤＰＣＭ出力は音量変換しても処理速度は変わりません
　　　（16/8ビットＰＣＭは音量変換を行うと処理速度が低下します）

　３）音量の可変範囲を広げ、音量の設定数を増やしました
　　　（可変範囲　： -53dB 〜 +26dB , 97段階 ）

　４）MPCM 相当の音程変換機能を搭載しました
　　　（MPCM.X と置き換えて使用可能です）

　５）チャンネル数／処理バイト数／音量の可変範囲が変更できます
　　　（常駐時に指定すると、常駐サイズが変化します）

　６）デバイスドライバとして登録可能です
　　　（デバイスドライバとして登録されていても常駐解除できます）

　７）Ｘｅｌｌｅｎｔ３０シリーズのローカルＳＲＡＭ上での動作に対応
　　　（Ｘｅｌｌｅｎｔ３０シリーズは、東京システムリサーチ株式会社製のアク
　　　　セラレータボードです）

　８）０４０ｔｕｒｂｏに対応
　　　（０４０ｔｕｒｂｏは、ＢＥＥＰｓ氏開発 ，株式会社 計測技研が販売する
　　　　アクセラレータボードです）

　９）ツクモ製１６ＭＢ増設メモリ（１６ＭＢハイメモリ）上の常駐動作に対応

　10）ラスター割り込みに対応
　　　（ＭＰＣＭモードでは不完全になる場合があります）

　11）ＡＤＰＣＭのクロックアップに対応

　12）欠点：プログラムサイズ・常駐サイズが PCM8 より大きくなっています
　　　（プログラム 70K バイト , 常駐 230K 〜標準:370K〜 400K バイト）


▲使用方法

　基本的に PCM8 と同じになっていますが、機能を一部追加しています。
　（追加機能の詳細は PCM8ATEC.DOC を参照してください）

　コマンドラインからは PCM8A [ｽｲｯﾁ] で組み込まれます。

　また、CONFIG.SYS からは DEVICE= の指定で組み込むことができ、デバイス名は
PCM (または @PCM) となります。

　スイッチは以下の通りです。

	ON	：多重再生許可（デフォルト）

	OFF	：多重再生禁止

	FNC	：trap #2 のファンクションコールのみ多重再生可能
		　IOCSは単音再生となります

	CLR	：全チャンネルを初期化します
		　動作モードの設定は変わりません

	-R	：常駐解除
		　他のアプリケーションにより解除が禁止されている場合は解除
		　できません
		　CONFIG.SYS 中で指定すると、PCM8A がメモリ上に残ったまま
		　常駐が解除された状態になり、次に PCM8A を常駐させる時に
		　メモリ上に残っていた PCM8A が有効になります

	-D[num]	：動作状態表示モード設定
		　num =	　0	：ＯＦＦ（デフォルト）
			　1	：ＯＮ
			省略	：ＯＦＦ／ＯＮ 状態反転

	-V[num]	：音量可変モード設定
		　num =	　0	：音量固定
			　1	：音量可変（デフォルト）
			省略	：固定／可変 状態反転
		　音量固定にすると、それ以降の出力は原音固定となります

	-Inum	：IOCSで使用可能なチャンネルの最大数
		　num = 0 〜 9	（デフォルト = 9 ）
		　0 に設定すると、IOCS出力が禁止されます

	-N	：デバイスドライバ組み込み時に指定すると、デバイス名を
		　 @PCM にして組み込みます
		　コマンドラインからの常駐時に指定しても無視します

	-S[num1],[num2],[num3],[num4]
		：システムの状態設定
		　num1 ：最大チャンネル数（ 1 〜250 :デフォルト= 25 ）
		　num2 ：処理バイト数/12 （ 1 〜 12 :デフォルト=  4 ）
		　num3 ：音量の最小値（ 0〜15 , $40〜$A0 :デフォルト= $40 ）
		　num4 ：音量の最大値（ 0〜15 , $40〜$A0 :デフォルト= $A0 ）
			 （ $ 又は X を頭に付けると16進数になります）
		　常駐時に指定すると、常駐サイズが変化します
		　"-S" のみを指定すると現在の状態を表示します

	-Wnum	：常駐時にバッファやテーブルを MALLOC で確保します
		  num  ：MALLOCで確保するバッファ／テーブルの指定
		         （ 1 〜 31 ,ビット 0 〜 4 で指定する）
			 （ $ 又は X を頭に付けると16進数になります）
		  コマンドラインからの常駐時のみ有効です
		  詳細は『“−Ｗ”オプションについて』を参照してください

	-Mnum	：ADPCMのクロックアップモードを指定
		　（詳細は PCM8AVUP.DOC を参照）

	-Fnum	：動作基準周波数を指定
		　（詳細は PCM8AVUP.DOC を参照）

　スイッチに誤りがある場合、ヘルプを表示します。

　なお、PCM8A が常駐している状態で、PCM8 OFF や PCM8 -R のような、PCM8 に
よる動作中のモード変更や常駐解除の制御が可能になっています。
　（ PCM8 と PCM8A で、制御方法が共通のため、逆も可能です）


▲“−Ｗ”オプションについて

　　PCM8A をＸｅｌｌｅｎｔ３０シリーズのローカルＳＲＡＭや１６Ｍバイト以上
　のハイメモリ上で常駐動作させる為に使用します。

　１）　このオプションはコマンドラインからの常駐時にのみ有効で、常駐後やデ
　　　バイスドライバとしての登録時には無視します。

　２）　-Wnum の形式で指定し、num の ビット0〜4 の５ビットにより MALLOC で
　　　確保するバッファ／テーブルを選択できます。
　　　　各ビットが対応するバッファ／テーブルは次の通りです。

　　　┌───┬──────────┬──────────┬──┬──┐
　　　│ビット│バッファ／テーブル名│　使用するバイト数　│CPU │DMAC│
　　　├───┼──────────┼──────────┼──┼──┤
　　　│　０　│ PCMバッファ　　　　│ 処理バイト数*16    │R/W │ − │
　　　├───┼──────────┼──────────┼──┼──┤
　　　│　１　│ ADPCMバッファ　　　│ 処理バイト数*6 　　│ WR │ RD │
　　　├───┼──────────┼──────────┼──┼──┤
　　　│　２　│ チャンネルバッファ │ 全チャンネル数*128 │R/W │ − │
　　　├───┼──────────┼──────────┼──┼──┤
　　　│　３　│ PCM→ADPCMテーブル │ 103168 (64K+768*49)│ RD │ − │
　　　├───┼──────────┼──────────┼──┼──┤
　　　│　４　│ ADPCM→PCMテーブル │ (音量設定数+97)*1K │ RD │ − │
　　　└───┴──────────┴──────────┴──┴──┘
　　　　CPU/DMACの欄は、割り込み処理中に各領域に対して行われるアクセスの種
　　　類です。（RD:読み出しのみ,WR:書き込みのみ,R/W:読み出しと書き込み）
　　　　なお、ビット４のADPCM→PCMテーブルは配置が１Ｋバイトを単位としてい
　　　るため、使用バイト数が最悪１Ｋバイト程度大きくなる場合があります。
　　　　また、その他のバッファやテーブルも１６バイトを単位としています。
　　　（ MALLOC は１６バイトを単位としているので、バイト数が大きくなること
　　　はありません）
　　　　なお、使用するバイト数は、今後のバージョンアップに伴い変化する可能
　　　性があります。

　　　　PCM8A をＸｅｌｌｅｎｔ３０シリーズのローカルＳＲＡＭ上や１６ＭＢ以
　　　上のハイメモリ領域で常駐動作させる場合、ADPCMバッファ を必ず MALLOC
　　　で確保する領域に設定する必要があります。

　　　　　　例：loadhigh pcm8a -w18

　　　　上の例では、18 は２進数では %10010 になるので、ビット１に対応する
　　　ADPCMバッファ とビット４の ADPCM→PCMテーブル をメインメモリに設定す
　　　る指定になります。

　３）　このオプションで指定されなかった領域は、プログラムの後ろに続けて確
　　　保します。


▲注意事項／その他

　１）　処理簡略化により多少の演算誤差を発生してしまい、音質の低下、定位の
　　　変化時のノイズ発生、大音量出力時の歪みの増加など、様々な副作用が発生
　　　しています。

　　　　音質を重視する場合、PCM8 又は MPCM を使用してください。


　２）　ＰＣＭ８Ａはバージョン 1.00以降、MPCM の機能を取り込んだことから、
　　　従来の音程変換処理の一部を汎用のルーチンで行うようになったため、速度
　　　が低下する場合があります。

　　　　そのため、６８０００の搭載機種で、音程変換機能を使用しない場合、
　　　バージョン 0.xxを使用することをお勧めします。


　３）　特にＭＰＣＭモードを使用すると、ＣＰＵにかなりの負担をかけます。
　　　　このため、６８０００の搭載機種では、ＭＰＣＭモードが実質使用不可能
　　　に近くなります。
　　　　そこで、動作を少しでも軽くする方法を紹介します。

　　　(1) −Ｓオプションで処理バイト数を増やす
　　　　　割り込み１回分の処理バイト数を増やしてやる事で、多少の負荷を軽減
　　　　できますが、音楽のテンポの乱れが起きやすくなります。

　　　　　　例）PCM8A -S,6   (デフォルトは -S,4)

　　　　　6の部分は最大12まで指定できますが、効果は僅かです。

　　　(2) −Ｆオプションで出力周波数を下げる
　　　　　ＡＤＰＣＭの動作周波数を下げることで、データの処理量を減らせます
　　　　が、音質の低下が激しくなります。
　　　　　ただし、ＡＤＰＣＭの負荷はあまり下がりません。

　　　　　　例）PCM8A -F7    (デフォルトは -F0)

　　　　　7の部分は4〜6も指定できますが、4まで下げると音質は最悪です。

　　　(3) −Ｓオプションで動作チャンネル数を減らす
　　　　　動作しているチャンネルを止めれば軽くなるのは当然ですが、動作して
　　　　いないチャンネルを削るだけでも、少しは負荷を減らすことができます。

　　　　　　例）PCM8A -S16   (デフォルトは -S25)

　　　(4) −Ｖオプションで音量を原音に固定する
　　　　　音量変換を行わないようにすることで、１６ビットＰＣＭの負荷を減ら
　　　　すことができますが、ＡＤＰＣＭの負荷は変わりません。

　　　　　　例）PCM8A -V0    (デフォルトは -V1)


　４）　“−Ｓ”オプションは常駐時に指定するだけでなく、常駐後にも指定でき
　　　ますが、常駐時に指定した値よりワークエリアが広く必要になる指定を、常
　　　駐後に指定することはできません。

　　　　ワークエリアが広く必要になるのは以下の場合です。
　　　　　(1) 全チャンネル数を増やす場合
　　　　　(2) 処理バイト数を増やす場合
　　　　　(3) 音量の最小値を小さくした場合
　　　　　(4) 音量の最大値を大きくした場合

　　　　なお、“−Ｓ”オプションを指定せずに常駐させた場合は特別に、ワーク
　　　エリアが確保されるサイズとデフォルトの設定とが異なり、以下のようにな
　　　ります。
　　　　　(1) 全チャンネル数=  32（デフォルト=  25 ）
　　　　　(2) 処理バイト数  = 144（デフォルト=  48 ）
　　　　　(3) 音量の最小値  = $40（デフォルト= $40 ）
　　　　　(4) 音量の最大値  = $A0（デフォルト= $A0 ）

　　　　つまり、-S32,12,$40,$A0 と指定して常駐した後に、-S25,4,$40,$A0 と
　　　指定した場合と同じになります。

　　　　また、常駐時の全チャンネル数は 25 未満にはできません。


　５）　デバイスドライバとして組み込んだ場合、-R で組み込みを解除しても、
　　　メモリ上にはＰＣＭ８Ａの本体が残っています。

　　　　そして、ＰＣＭ８Ａを再び組み込む場合、デバイスドライバ名（ PCM 又
　　　は @PCM ）を元に、デバイスドライバとして組み込まれたＰＣＭ８Ａを、メ
　　　モリ上から探して有効にします。

　　　　なお、この時の動作モードは組み込み解除前の状態が保持されています。


　６）　１０ＭＨｚの機種においてＰＣＭ８Ａとラスター割り込みを併用すると、
　　　ＣＰＵに負担がかかり過ぎ、ＰＣＭ８Ａの動作が不安定になったり、他のプ
　　　ログラムの動作に悪影響を及ぼす恐れがあるので、併用は避けたほうが無難
　　　です。
　　　　また、多数の割り込みが同時に発生した場合などに、ラスター割り込みが
　　　失敗する可能性もあります。


　７）　プログラム作成の際にはバグ混入の無いよう心掛けていますが、本プログ
　　　ラムの使用に起因する、損害に関する責任は負いかねます。

　　　　特に本プログラムの動作はハードウェアに密着しているため、使用者の環
　　　境に大きく左右され、作者の環境下では絶対に発生しない不都合や、ソフト
　　　ウェア的に回避できない不都合が発生する可能性があることを、予め御了承
　　　願います。

　　　　ちなみに、本プログラムは X68000(無印)+増設3M 及び X68030+増設8M で
　　　開発と動作確認を行っています。


　８）　本プログラムとソースリスト及びドキュメントはフリーウェアとします。

　　　　配布の制限はありません。連絡も不要です。

　　　　改変は自由ですが、改変した内容はドキュメント等に明記し、タイトル変
　　　更等の手段で、改変したプログラムであることを、利用者が容易に判別でき
　　　るようにしておいてください。

　　　　但し、利用者に不当な利益を及ぼす改変は禁止します。


▲以下のツールをプログラムの作成（とデバッグ）に使用しました

　　X68k High-speed Assembler v2.55 Copyright 1990,91,92 by Y.Nakamura
　　X68k High-speed Assembler v3.08 Copyright 1990-94 by Y.Nakamura

　　X68k SILK Hi-Speed Linker v2.27 Copyright 1989-92 SALT
　　X68k SILK Hi-Speed Linker v3.01 Copyright 1989-94 SALT

　　X680x0 Screen Editor (ED.R) ver 0.99XI Copyright 1991,92,93 by S.Ueda

　　ソースコードジェネレータ for X680x0 version 2.77
　　Copyright (C) 1989-1992 K.Abe , 1994-1995 R.ShimiZu

　　MEMORYSCOPE for X68000 version 0.03
　　Copyright 1990,1991 Tsune Art Studio/K.Tsuneyoshi(Tsune)

　　< Process launcher > launch.x by Chapuni Nakamura

　　<<Street Fighter II'>> SF2.X patch  version 1.03  (C)1993 E.Watanabe

　　<<GAROU DENSETSU 2>> GARO2.X patch  version 1.13  (C)1993,94 E.Watanabe

　　<<SuperStreetFighterII>> SP2.X patch  version 1.11  (C)1994,95 E.Watanabe
			　　 拙者も助太刀 version 1.05a (C)1994 ずうやん

　　その他 SHARP/Hudson 開発のプログラムの数々


　また、本プログラムの動作確認にあたり、数種のＦＭ音源ドライバとそのサポー
トツール、及び数多くの音楽データを使用させていただきました。
　（古いバージョンのものが含まれている場合もあります）

　　X68k MXDRV music driver version 2.06+16 Rel.1
			(c)1988-91 milk.,K.MAEKAWA, Missy.M, Yatsube

　　X68k MDX AUDIO DRIVER version 2.00a HSX/2.06+15/16 (c)1991,92 Konoa.

　　Z-MUSIC UNIVERSAL VERSION 1.52 (C) 1991,1992,1993 ZENJI SOFT
　　Z-MUSIC UNIVERSAL VERSION 2.08 (C) 1991,1992,1993,1994 ZENJI SOFT

　　X68k music creative driver version 0.60 (c)1993-95 CUL.

　　ＭＺＰ [ Multi music data player for Z-MUSIC ]  Ver. 1.12b
							(C)1991-93 NOVA
　　MXtoZ [ MDX data converter for Z-MUSIC ]  Ver. 0.43a  (C)1991-93 NOVA

　　X68k multi music status display MMDSP.r v0.29 (c)1991-94 Miahmie, Gao

　　SXZC v2.48 Copyright 1991-93 けんと

　　多数のＭＤＸファイル

　　電脳倶楽部掲載のＺＭＳファイル


　作成者の方々にこの場を借りてお礼申し上げます。


▲謝辞

　　本プログラムの、Ｘｅｌｌｅｎｔ３０シリーズでの動作確認及び不具合の報告
　をしていただいた以下の方々に感謝致します。

　　　E.Watanabe さん　,　P.E.I. さん

　　本プログラムの、０４０ｔｕｒｂｏでの不具合報告及び正式対応の実験に協力
　していただいた以下の方に感謝致します。

　　　カップめん さん

　　本プログラムを、ツクモ製１６ＭＢ増設メモリ（ＴＳ−６ＢＥ１６）上に常駐
　させた場合の不具合報告及びアドバイスをいただいた以下の方に感謝致します。

　　　E.Watanabe さん


▲参考文献及び参考としたプログラム

　１）PCM8.X	X68k PCM8 polyphonic PCM driver v0.48 (c)1991,92 H.Etoh
		X68k PCM8 polyphonic PCM driver v0.48a (c)1991,92 H.Etoh
		X68k PCM8 polyphonic PCM driver v0.48b (c)1991-93 H.Etoh
		及び　ドキュメント／テクニカルマニュアル

　２）江藤　啓：「マルチチャンネルＡＤＰＣＭドライバ　ＰＣＭ８」
		　ソフトバンク株式会社　Ｏｈ！Ｘ　１９９２年６月号

　３）MPCM.X	Modulatable (ad)PCM driver MPCM.x version. 0.45
				copyright (c) 1994,95,96 by wachoman
		及び　ドキュメント

　４）ADPCM4.X	M3system/X68000 multi voice ADPCM driver
		Copyright (c) 1993 by S.P.S

　５）X68k-Xellent30 loadhigh.r version 1.21  (C)1995 E.Watanabe
		及び　ドキュメント

　６）E.Watanabe：「Ｘｅｌｌｅｎｔ３０を抉る！　第１回」
		　　株式会社満開製作所　電脳倶楽部　Ｖｏｌ８５

　７）E.Watanabe：「Ｘｅｌｌｅｎｔ３０を抉る！　第２回」
		　　株式会社満開製作所　電脳倶楽部　Ｖｏｌ８６

　８）E.Watanabe：「Ｘｅｌｌｅｎｔ３０を抉る！　第３回」
		　　株式会社満開製作所　電脳倶楽部　Ｖｏｌ８７

　９）E.Watanabe：「Ｘｅｌｌｅｎｔ３０を抉る！　第４回」
		　　株式会社満開製作所　電脳倶楽部　Ｖｏｌ８８

　10）ＢＥＥＰｓ：「Ｘ６８／０４０ｔｕｒｂｏ」ソフトバンク株式会社

　11）日立データブック１９８９
　　　「６８００，６８０００シリーズ　マイクロプロセッサ・周辺ＬＳＩ」
　　　　ＨＤ６３４５０／ＨＤ６８４５０　ＤＭＡＣ

　12）宍倉幸則：「６８０００プログラマーズ・ハンドブック」，技術評論社

　13）ＰＯＰＣＯＭ編集部・編：「Ｘ６８０００データブック」，小学館


▲最後に

　　本プログラムの作成に当たり参考及び目標となった PCM8.X は、Ｘ６８０ｘ０
　ユーザー必携の優れたソフトウェアであり、今後さらなる発展を遂げることを切
　に願うとともに、ここに故人の多大なる御功績を偲び、心から御冥福申し上げま
　す。


（ＥＯＦ）
