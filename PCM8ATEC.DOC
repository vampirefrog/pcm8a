┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃									┃
┃	リアルタイム　ＡＤＰＣＭ多重再生ドライバー　『ＰＣＭ８Ａ』	┃
┃									┃
┃	version 0.57	テクニカルマニュアル				┃
┃						philly 1993-1995	┃
┃									┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛

〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜
１．ＰＣＭデータ形式

	ＰＣＭ８Ａが取り扱える PCM データの形式は、以下の３種類です。

	（１）ＡＤＰＣＭ	（周波数は７段階）

		　X680x0 で標準的に使われているＰＣＭデータです。

	（２）１６ビットＰＣＭ	（周波数は３段階）

		　Ｃ言語の signed short に相当します。
		　この形式のデータは、常に偶数番地から始まり、データの長さ
		も偶数バイトが指定されていなくてはなりません。

	（３）８ビットＰＣＭ	（周波数は３段階）

		　Ｃ言語の signed char に相当します。
		　出力時は、８ビットのデータの符号を拡張して１６ビットとし、
		合成を行います。


〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜
２．ＰＣＭ８Ａコール方法

	以下の２種類の方法をサポートしています。

	（１）trap #2 命令を使用したファンクションコール

	（２）IOCS コールによる簡易使用


〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜
３．ＰＣＭ８Ａファンクション一覧

	　trap #2 命令を使用したファンクションコールの詳細を示します。

	　D0.W に機能コードを設定し、他のレジスタに適切な値を設定した後、
	 trap #2 命令を実行してください。

	　戻り値は D0.L に設定され、他のデータ／アドレスレジスタは全て保存
	されます。

	　以下の内容は、PCM8A version 0.57 の時点のものです。

━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
　１：通常出力					機能コード $000x , $10xx
─────────────────────────────────────

機能：	単一メモリ領域のデータを出力する

呼出：	D0.W	$0000 + チャンネル番号 (0〜15)
		$1000 + チャンネル番号 (0〜最大チャンネル番号)

	D1.L	音量／周波数／定位の指定

		ビット
		23〜16	：音量指定（ $FF , $00〜$0F , $40〜$A0 ）

			　$FF	　　：前の値を保持
			　$00〜$0F　：原音量は $08
				　　　（ -16dB〜+14dB ,１ステップ≒ 2dB）
			　$40〜$A0　：原音量は $80
				　　　（ -53dB〜+26dB ,１ステップ≒0.8dB）
			　※詳細は『７．音量変換の詳細について』を参照
			　　単音再生モードでは常に原音量で出力する

		15〜 8	：周波数及びデータ形式の指定（ $FF , $00〜$0C ）

			　$FF	　　：前の値を保持
					　　設定値一覧
			　　┌────┬───┬────┬────┐
			　　│ 周波数 │ ADPCM│16bitPCM│ 8bitPCM│
			　　├────┼───┼────┼────┤
			　　│ 3.9 kHz│  $00 │  ──  │  ──  │
			　　├────┼───┼────┼────┤
			　　│ 5.2 kHz│  $01 │  ──  │  ──  │
			　　├────┼───┼────┼────┤
			　　│ 7.8 kHz│  $02 │  ──  │  ──  │
			　　├────┼───┼────┼────┤
			　　│10.4 kHz│  $03 │  ──  │  ──  │
			　　├────┼───┼────┼────┤
			　　│15.6 kHz│  $04 │  $05   │  $06   │
			　　├────┼───┼────┼────┤
			　　│20.8 kHz│  $07 │  $08   │  $09   │
			　　├────┼───┼────┼────┤
			　　│31.2 kHz│  $0A │  $0B   │  $0C   │
			　　└────┴───┴────┴────┘
			　※単音再生モードでは 20.8kHz/31.2kHz ADPCM形式や
			　　16bit/8bit PCM形式は指定できない

		 7〜 0	：定位指定（ $FF , $00〜$03 ）

			　$FF	　　：前の値を保持
			　$00	　　：再生停止
				　　　（音量／周波数は変更されるが、定位は
					変更されない）
			　$01	　　：左出力
			　$02	　　：右出力
			　$03	　　：左右（中央）出力
			　※この指定は全チャンネルに共通であり、最後に指定
			　　された $00 以外の値が有効になる

		他のビットは無効

	D2.L	出力するデータのバイト数

		＜ 0　　：データ長問い合わせ（機能コード $008x と同機能）
		＝ 0　　：チャンネル動作停止
			　（音量／周波数／定位は変更されない）
		※16ビットＰＣＭ出力時には偶数を指定すること

	A1.L	データ先頭アドレス

		※16ビットＰＣＭ出力時には偶数アドレスを指定すること

戻値：	D0.L	（ D2.L ＜ 0 の場合、機能コード $008x を参照のこと）
		＝ 0	：正常終了
		＝ -1	：出力不可能


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
　２：アレイチェーン出力			機能コード $001x , $11xx
─────────────────────────────────────

機能：	アレイチェーンテーブルによって、間接的に指定された複数のメモリ領域
	のデータを出力する

呼出：	D0.W	$0010 + チャンネル番号 (0〜15)
		$1100 + チャンネル番号 (0〜最大チャンネル番号)

	D1.L	音量／周波数／定位の指定

		通常出力（$000x）の指定に同じ

	D2.L	アレイチェーンデータの個数

		＜ 0　　：データ長問い合わせ（機能コード $008x と同機能）
		＝ 0　　：チャンネル動作停止
			　（音量／周波数／定位は変更されない）
		※単音再生モードでは、最大 65535（$FFFF） まで

	A1.L	アレイチェーンテーブル先頭アドレス
		（アレイチェーンテーブルについての説明は省略）

		※必ず偶数アドレスを指定すること

戻値：	D0.L	（ D2.L ＜ 0 の場合、機能コード $008x を参照のこと）
		＝ 0	：正常終了
		＝ -1	：出力不可能


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
　３：リンクアレイチェーン出力			機能コード $002x , $12xx
─────────────────────────────────────

機能：	リンクアレイチェーンテーブルによって、間接的に指定された複数のメモ
	リ領域のデータを出力する

呼出：	D0.W	$0020 + チャンネル番号 (0〜15)
		$1200 + チャンネル番号 (0〜最大チャンネル番号)

	D1.L	音量／周波数／定位の指定

		通常出力（$000x）の指定に同じ

	A1.L	リンクアレイチェーンテーブル先頭アドレス
		（リンクアレイチェーンテーブルについての説明は省略）

		※必ず偶数アドレスを指定すること

戻値：	D0.L	＝ 0	：正常終了
		＝ -1	：出力不可能


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
　４：動作モード変更				機能コード $007x , $17xx
─────────────────────────────────────

機能：	動作中のチャンネルの音量／周波数／定位を変更する

呼出：	D0.W	$0070 + チャンネル番号 (0〜15)
		$1700 + チャンネル番号 (0〜最大チャンネル番号)

	D1.L	音量／周波数／定位の指定

		通常出力（$000x）の指定に同じ

戻値：	D0.L	＝ 0	：正常終了


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
　５：データ長問い合わせ			機能コード $008x , $18xx
─────────────────────────────────────

機能：	動作中のチャンネルの残りデータ長を取得する

呼出：	D0.W	$0080 + チャンネル番号 (0〜15)
		$1800 + チャンネル番号 (0〜最大チャンネル番号)

戻値：	D0.L	＝ 0	：チャンネルは停止中
		＞ 0	：残りのデータのバイト数
			　（多重再生モードで、通常出力中）
		＝ -1	：アレイチェーン出力中
		＝ -2	：リンクアレイチェーン出力中
		＝ -3	：単音再生モードで出力中


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
　６：動作モード問い合わせ			機能コード $009x , $19xx
─────────────────────────────────────

機能：	動作中のチャンネルの音量／周波数／定位を取得する

呼出：	D0.W	$0090 + チャンネル番号 (0〜15)
		$1900 + チャンネル番号 (0〜最大チャンネル番号)

戻値：	D0.L	＞ 0	：音量／周波数／定位

			　通常出力（$000x）を参照のこと
			　※定位は常に $01〜$03 の値となり、ビット 31〜24
			　　は常に 0 となる


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
　７：アクセスアドレス問い合わせ		機能コード $00Ax , $1Axx
─────────────────────────────────────

機能：	動作中のチャンネルのアドレスポインタの情報を取得する

呼出：	D0.W	$00A0 + チャンネル番号 (0〜15)
		$1A00 + チャンネル番号 (0〜最大チャンネル番号)

戻値：	D0.L	≧ 0	：ＡＤＰＣＭ／ＰＣＭデータのアドレスポインタ情報


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
　８：チャンネル一時停止			機能コード $00Bx , $1Bxx
─────────────────────────────────────

機能：	チャンネルの動作を一時停止する

	　この処理は $000x , $001x のコールで、 D2.L ＝ 0 を指定した場合と
	同じになる

呼出：	D0.W	$00B0 + チャンネル番号 (0〜15)
		$1B00 + チャンネル番号 (0〜最大チャンネル番号)

戻値：	D0.L	＝ 0	：正常終了

	　一時停止（$0101）とは別に扱われ、どちらかのコールで一時停止が指
	定されれば、チャンネルの動作は一時停止状態に入る


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
　９：チャンネル一時停止解除			機能コード $00Cx , $1Cxx
─────────────────────────────────────

機能：	チャンネルの一時停止状態を解除する

呼出：	D0.W	$00C0 + チャンネル番号 (0〜15)
		$1C00 + チャンネル番号 (0〜最大チャンネル番号)

戻値：	D0.L	＝ 0	：正常終了
		＝ -1	：一時停止解除不可能

	　一時停止解除（$0102）とは別に扱われ、両方のコールで一時停止が解
	除された場合のみ、チャンネルの一時停止状態は解除される
	　過負荷状態になり、一時停止状態になった出力を、このコールで継続出
	力させることができる
	　動作が打ち切られた後の継続出力も可能だが、ＰＣＭ８Ａが初期化され
	た後は無効


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
１０：終了						機能コード $0100
─────────────────────────────────────

機能：	全チャンネルのチェイン動作を解除し、現在出力中のデータブロックの出
	力が完了次第、チャンネルの動作を停止する

	　一時停止中の場合は即座に全チャンネルの動作を打ち切る

呼出：	D0.W	$0100

戻値：	D0.L	＝ 0	：正常終了

	　即時終了ではない点に注意すること
	　即時に完全に終了させたい場合は、一時停止（$0101）の後、本コール
	を実行する必要がある
	　単音出力中でも、一時停止（$0101）実行後に本コールを実行すること
	により、即時終了させることができる


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
１１：一時停止						機能コード $0101
─────────────────────────────────────

機能：	全チャンネルの出力を即座に停止し、一時停止状態に入る

	　一時停止状態でチャンネル出力または終了を行うと、全チャンネルの動
	作が打ち切られる

呼出：	D0.W	$0101

戻値：	D0.L	＝ 0	：正常終了

	　単音出力中は一時停止しないが、終了（$0100）と組み合わせることで、
	即時終了させることができる


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
１２：一時停止解除					機能コード $0102
─────────────────────────────────────

機能：	一時停止状態を解除する

	　動作が打ち切られた後は無効

呼出：	D0.W	$0102

戻値：	D0.L	＝ 0	：正常終了
		＝ -1	：一時停止解除不可能

	　単音出力中は、このコールは無視される


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
１３：ＰＣＭ８Ａ停止					機能コード $0103
─────────────────────────────────────

機能：	ＰＣＭ８ＡによるＡＤＰＣＭの管理を停止する

呼出：	D0.W	$0103

戻値：	D0.L	＝ 0	：正常終了

	　この命令が実行されると、ＡＤＰＣＭ及びＰＣＭ８Ａは初期化され、待
	機状態に入る
	　この命令の実行で、ノイズが出力されることがある
	　待機状態で出力を行うと、ＡＤＰＣＭはＰＣＭ８Ａによって管理される
	状態に戻る


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
１４：ＰＣＭ８Ａ動作					機能コード $0104
─────────────────────────────────────

機能：	ＡＤＰＣＭの管理をＰＣＭ８Ａに渡す

呼出：	D0.W	$0104

戻値：	D0.L	＝ 0	：正常終了

	　この命令が実行されると、ＡＤＰＣＭ及びＰＣＭ８Ａは初期化され、動
	作状態に入る
	　この命令の実行で、ノイズが出力されることがある


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
１５：ＰＣＭ８Ａシステム情報設定			機能コード $01F8
─────────────────────────────────────

機能：	ＰＣＭ８Ａシステム情報の取得／設定

呼出：	D0.W	$01F8

	D1.L	＝ -1	：システム情報取得
		≠ -1	：システム情報設定

			ビット
			31〜24	：チャンネル数（ $FF , $01〜$7F ）

				　$FF	　　：前の値を保持
				　$01〜$FA　：最大チャンネル数
				　※デフォルトは $08

			23〜16	：割り込み１回の処理バイト数/12
				　（ $FF , $01〜$0C ）

				　$FF	　　：前の値を保持
				　$01〜$0C　：処理単位
				　※デフォルトは $04（48バイト単位）
				　　15.6kHz のADPCMを使用したモードが基準
				　　となっている

			15〜 8	：音量最大値
				　（ $FF , $08〜$0F , $80〜$A0 ）

				　$FF			：前の値を保持
				　$08〜$0F , $80〜$A0	：音量最大値
				　※デフォルトは $A0

			 7〜 0	：音量最小値
				　（ $FF , $00〜$08 , $40〜$80 ）

				　$FF			：前の値を保持
				　$00〜$08 , $40〜$80	：音量最小値
				　※デフォルトは $40

戻値：	D0.L	（変更前の）システム情報

			ビット
			31〜24	：チャンネル数

				　$01〜$FA　：全チャンネル数

			23〜16	：割り込み１回の処理バイト数/12

				　$01〜$0C　：処理単位

			15〜 8	：音量最大値

				　$08〜$0F , $80〜$A0	：音量最大値

			 7〜 0	：音量最小値

				　$00〜$08 , $40〜$80	：音量最小値

	　この命令を割り込み処理中に使用し、割り込み１回の処理バイト数を切
	り替えることで、ＰＣＭ８Ａの割り込みタイミングをある程度制御するこ
	とができます。
	　ただし、設定を行ってから実際に割り込み間隔が変化するのは、ＰＣＭ
	８Ａの割り込み処理が３回実行された後になります。


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
１６：ＰＣＭ８Ａシステム情報問い合わせ			機能コード $01F9
─────────────────────────────────────

機能：	ＰＣＭ８Ａシステム情報の取得

呼出：	D0.W	$01F9

戻値：	D0.L	システム情報

		ビット
		31〜16	：割り込み１回の処理バイト数

			　$000C〜$0090　：処理バイト数
			　※ＰＣＭ８Ａシステム情報設定（ $01F8 ）の
			　　ビット23〜16 を 12倍した値を返す

		15〜 8	：音量設定最大値

			　$80〜$A0　：音量最大値
			　※$08〜$0F の値は $80〜$91 に変換される

		 7〜 0	：音量設定最小値

			　$40〜$80　：音量最小値
			　※$00〜$08 の値は $6B〜$80 に変換される


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
１７：動作モード問い合わせ／変更			機能コード $01FA
─────────────────────────────────────

機能：	動作モード情報の取得／設定

呼出：	D0.W	$01FA

	D1.L	＜ 0	：動作モード取得
		≧ 0　　：動作モード設定

			ビット
			27	：動作表示モード反転
			26	：音量可変モード反転
			23〜16	：IOCSで使用できるチャンネル数
				　（ $FF , $FE , $00〜$FA ）

				　　$FF	　　　：前の値を保持
				　　$FE	　　　：全チャンネルを使用
						（デフォルト）
				　　$00	　　　：IOCS出力禁止
				　　$01〜$FA　：IOCS出力チャンネル数

			※ビット 27,26 はモード反転時に 1 を設定する
			　ビット 31〜28 は 0 を設定しておくこと
			　他のビットは無効

戻値：	D0.L	≧ 0	：（変更前の）動作モード情報

			ビット
			27	：動作表示モード

				　　0	：動作表示無し
				　　1	：動作表示有り

			26	：音量可変モード（trap #2 による設定状態）
			25	：	〃
					（コマンドラインによる設定状態）
				　　0	：音量固定
				　　1	：音量可変
				　※音量可変モードの設定はコマンドラインの
				　　指定とは別に扱われ、両方で音量可変を指
				　　定した場合に限り、音量は可変となる

			24	：組み込みモード

				　　0	：コマンドラインからの組み込み
				　　1	：デバイスドライバ組み込み

			23〜16	：IOCSで使用できるチャンネル数

				　　$00		：IOCS出力禁止
				　　$00以外	：IOCS同時出力チャンネル数

			15〜 8	：全チャンネル数
			 7〜 0	：動作中チャンネル数
				　※単音出力モードでは常に $00 となる


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
１８：ＭＰＵ・ＭＦＰマスク設定				機能コード $01FB
─────────────────────────────────────

機能：	ＰＣＭ８Ａ割込中のＭＰＵ／ＭＦＰ割込マスクを設定する

呼出：	D0.W	$01FB

	D1.L	割り込みレベル／マスクデータ指定

		＜ 0	割り込みレベル／マスク情報取得
		≧ 0	割り込みレベル／マスク情報設定

			ビット
			18〜16	：ＭＰＵ割り込みレベル（3〜7）
			15〜 8	：ＭＦＰ割り込みマスクＡ（IMRA）
			 7〜 0	：ＭＦＰ割り込みマスクＢ（IMRB）
			※ビット15〜0の意味は、0 で割り込みマスク、1 で割
			　り込み開始前と同じ状態、の意味になる

戻値：	D0.L	≧ 0	：（変更前の）割り込みレベル／マスク値
			　※ビット 31〜19 は 0 となる

	　割り込み処理についてよく理解してから使用すること

	　既定値は %xxxxxxxx_xxxxx011_11011111_00000000（ x：無効ビット ）


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
１９：多重／単音モードの設定				機能コード $01FC
─────────────────────────────────────

機能：	多重再生を許可／禁止する

呼出：	D0.W	$01FC

	D1.W	＝ -1	：取得のみ
		＝ 0	：多重再生禁止（単音モード）
		＝ 1	：多重再生許可
		＝ 2	：ファンクションコールのみ多重再生許可

戻値：	D0.L	＝ 0	：多重再生禁止中
		＝ 1	：多重再生許可中
		＝ 2	：ファンクションコールのみ多重再生許可中
		※変更前の設定状態が戻値となる

	　多重再生禁止中は、ＩＯＣＳ出力及びファンクションによる出力は後か
	ら行われたものが有効となる
	　多重再生許可状態（ 1 または 2 ）から多重再生禁止状態（ 0 ）、ま
	たはその逆へ切り替えた場合、全チャンネルを初期化する


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
２０：（reserved）					機能コード $01FD
─────────────────────────────────────

	本コールは予約されています


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
２１：占有						機能コード $01FE
─────────────────────────────────────

機能：	ＰＣＭ８Ａを占有し、常駐解除を禁止する

呼出：	D0.W	$01FE

戻値：	D0.L	＝ 0	：占有した
		＝ -1	：既に占有されている

	　一般のプログラムでは使ってはならない


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
２２：占有解除						機能コード $01FF
─────────────────────────────────────

機能：	ＰＣＭ８Ａの占有を解除し、常駐解除を可能にする

呼出：	D0.W	$01FF

戻値：	D0.L	＝ 0	：占有解除した
		＝ -1	：占有されていない

	　一般のプログラムでは使ってはならない


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
２３：ＰＣＭ８Ａ割り込みフラグチェック			機能コード $FFF0
─────────────────────────────────────

機能：	ＰＣＭ８Ａが割り込み処理中かチェックする

呼出：	D0.W	$FFF0

戻値：	D0.L	＝ 0	：割り込み処理中ではない
		≠ 0	：割り込み処理中

	　一般のプログラムでは使ってはならない


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
２４：ＰＣＭ８Ａ内部初期化				機能コード $FFF1
─────────────────────────────────────

機能：	ＰＣＭ８Ａの全チャンネルと内部ワークを初期化する

	　動作モードは変わらない

呼出：	D0.W	$FFF1

戻値：	D0.L	＝ 0	：正常終了

	　一般のプログラムでは使ってはならない


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
２５：ワークアドレス問い合わせ				機能コード $FFFC
─────────────────────────────────────

機能：	ＰＣＭ８Ａで使用しているワークエリアの情報を取得する

呼出：	D0.W	$FFFC

	D1.W	ワークエリア番号
		＝ 0	：ＰＣＭバッファ
		＝ 1	：ＡＤＰＣＭバッファ
		＝ 2	：チャンネルバッファ
		＝ 3	：ＰＣＭ→ＡＤＰＣＭテーブル
		＝ 4	：ＡＤＰＣＭ→ＰＣＭテーブル

戻値：	D0.L	≧ 0	：バッファ／テーブルの先頭アドレス

	　一般のプログラムでは使ってはならない
	　戻値で示されたアドレスから、直接メモリ管理ポインタのアドレスを求
	める事はできません。


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
２６：使用ベクタ問い合わせ				機能コード $FFFD
─────────────────────────────────────

機能：	ＰＣＭ８Ａで使用しているベクタの情報を取得する

呼出：	D0.W	$FFFD

	D1.W	ベクタ番号

戻値：	D0.L	＝ -1	：使用していないベクタ番号である
		＝ -2	：組み込まれていないため、未使用である
			　（通常この値が返ることはない）
		上記以外：元のベクタアドレス

	　一般のプログラムでは使ってはならない

	　ＰＣＭ８Ａで使用しているベクタは以下の通りです

		番号
		$0022	TRAP #2
		$006A	DMAC ch.3 通常割り込み
		$006B	DMAC ch.3 エラー割り込み
		$0160	IOCS _ADPCMOUT
		$0161	IOCS _ADPCMINP
		$0162	IOCS _ADPCMAOT
		$0163	IOCS _ADPCMAIN
		$0164	IOCS _ADPCMLOT
		$0165	IOCS _ADPCMLIN
		$0166	IOCS _ADPCMSNS
		$0167	IOCS _ADPCMMOD

	　なお、ベクタ番号に $0000 を指定すると、ＰＣＭ８Ａの先頭アドレス
	を返します


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
２７：（reserved）					機能コード $FFFE
─────────────────────────────────────

	本コールは予約されています


━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
２８：常駐解除						機能コード $FFFF
─────────────────────────────────────

機能：	ＰＣＭ８Ａの常駐を解除する

呼出：	D0.W	$FFFF

戻値：	D0.L	＝ 0	：常駐が正常に解除された
		＝ -1	：占有されており、解除できなかった
		＝ -2	：ベクタが変更されており、解除できなかった

	　一般のプログラムでは使ってはならない


※注意
	　$FFF0 , $FFF1 , $FFFD , $FFFC のコールを使用する場合、必ず PCM8A
	が常駐していることを確認してから実行してください。
	　PCM8.X が常駐している状態でこれらのコールを使用すると、常駐解除
	（$FFFFコール）と解釈されてしまう可能性があります。


〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜
４．ＰＣＭ８Ａ　ＩＯＣＳコール

　４−１　対象コール

	$60	_ADPCMOUT	チェーンなし出力
	$62	_ADPCMAOT	アレイチェーン出力
	$64	_ADPCMLOT	リンクアレイチェーン出力
	$66	_ADPCMSNS	ＡＤＰＣＭ実行モードセンス
	$67	_ADPCMMOD	ＡＤＰＣＭ実行制御

	　ＰＣＭ８Ａは、上記以外のＡＤＰＣＭ関連のコールも全て管理します。

　４−２　元のＩＯＣＳとの差異

　　４−２−１　多重再生モード

	（１）　前の音の出力中に、続いて出力を行った場合、前の音の出力終了
	　　　を待たず、他のチャンネルを使用して出力を合成します。

	　　　　この場合、空いているチャンネルを、チャンネル番号の大きいも
	　　　のから順に使用します。
	　　　　このとき、空きのない場合は、チェーンなし出力中のチャンネル
	　　　の内、残り時間の一番短いものを潰して出力します。
	　　　　それでも該当するチャンネルが無い場合コールは無視し、復帰値
	　　　を D0.L ＝ -1 としてリターンします。

	　　　　チャンネルサーチでは、チャンネル一時停止（$00Bxコール）等
	　　　で一時停止状態にあるチャンネルでも空いていると判断して、勝手
	　　　に出力を割り当ててしまうので注意が必要です。

	（２）　通常出力（$60コール）及び通常入力（$61コール）では、出力バ
	　　　イト数が $FF00 以上でもすぐリターンします。

	（３）　定位は最新の指定に従いますが、出力カットの指定は無視します。
	　　　　定位変更時は先に出力中の残響も影響を受けてしまいます。

	（４）　ＡＤＰＣＭ実行制御（$67コール）で終了を指定すると、チェー
	　　　ン動作の終了となります。
	　　　　このとき、現在出力中のデータブロックはそのまま出力されます。
	　　　　即時終了する場合は、中止指定を行ってから終了を指定すること。

	　　　　中止指定の後、終了指定または他の音の再生指定を行うと、元の
	　　　出力は全てキャンセルされます。
	　　　　中止指定後は再開指定による継続出力も可能ですが、キャンセル
	　　　された出力の継続出力はできません。

	　　　　なお、ファンクションコールによる出力は、本コールによる影響
	　　　を受けません。

	（５）　ＡＤＰＣＭ実行モードセンス（$66コール）は、最後に行われた
	　　　ＩＯＣＳコールの状態を返します。

	（６）　入力処理中には、入力処理が完了するまで出力要求を全てキャン
	　　　セルします。
	　　　　このときの復帰値は D0.L ＝ -1 となります。

　　４−２−２　単音再生モード

	（１）　前の音の出力中に、続いて出力を行った場合、前の音の出力終了
	　　　を待たず、前の音の出力を取り消して出力します。
	　　　　また、入力に関しても出力と同様になります。

	（２）　通常出力（$60コール）及び通常入力（$61コール）では、出力バ
	　　　イト数が $FF00 以上でもすぐリターンします。

	（３）　入力処理中には、入力処理が完了するまで出力要求を全てキャン
	　　　セルします。
	　　　　このときの復帰値は D0.L ＝ -1 となります。

　　４−２−３　その他

	（１）　IOCS コールでは、16bit PCM , 8bit PCM の入出力はできません。

	（２）　IOCS コールの音量は原音固定です。


〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜
５．ＰＣＭ８Ａ常駐判定方法

	　ＰＣＭ８Ａファンクションコールを使用する場合は、予め常駐判定を
	行っておく必要があります。

	　常駐判定には、以下の方式を推奨します。

　５−１　トラップベクタ取得方式

	　例外ベクタ $0022（ trap #2 エントリ：絶対番地＝ $0088 ）の内容で
	示されたアドレスの手前１６バイトをチェックします。

	　先頭から５バイトが 'PCM8A' で、３バイトスキップして、続く８バイ
	トが 'PCM8/048' ならば常駐しています。
	　なお、スキップした３バイトはバージョンを示しています。
	（ 例：version 0.57 = 'PCM8A057PCM8/048' ）

　５−２　ＩＯＣＳコール方式（簡略方式）

	　D1.L に 定数 'PCMA' を設定して、IOCS $67（_ADPCMMOD）を実行し、
	戻り値 D0.L ≧ 0 であれば PCM8A は常駐しており、バージョンは
	 D0.L / 100（10進）で示されます。


〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜
６．注意事項／他

　６−１　ＯＰＭレジスタアクセスについて

	　ＰＣＭ８Ａは、ＯＰＭレジスタをアクセスする場合があります。

	　アクセスレジスタは $1B で、システムワーク $09DA を参照して値を決
	定するため、他のアプリケーションではシステムワークと実際の設定内容
	の食い違いが起こらないように注意する必要があります。

　６−２　ＰＣＭ８Ａ組み込み制御について

	　音源ドライバが独自にＡＤＰＣＭ処理を行う場合など、後からＰＣＭ８
	Ａが組み込まれると都合が悪い場合は、trap #2 のエントリ（絶対番地＝
	$0088）にダミーのアドレス（$00F00000 未満）を設定しておくと、ＰＣ
	Ｍ８Ａの組み込みを禁止できます。

　６−３　システムワーク $0C32 について

	　ＲＯＭ内部ルーチンによる処理では、$0C32 にはＡＤＰＣＭの動作状態
	が格納されていますが（$00,$02,$04,$12,$14,$22,$24,$82,$84 のいずれ
	かの値が入る）、ＰＣＭ８ＡがＡＤＰＣＭを管理している状態では、ここ
	に $42 を格納します。

　６−４　過負荷状態について

	　過負荷状態とは、ＰＣＭ８Ａの割込み処理がある時間以内に終了しな
	かったために、ＡＤＰＣＭ出力が停止してしまう状態を指します。

	　この状態になる原因として、同時動作チャンネル数が多すぎる場合以外
	にも、ＰＣＭ８Ａの割り込み処理中に入った別の割り込み処理の時間が長
	い場合や、割り込みレベル３以上の時間が長くなった等の原因で、ＰＣＭ
	８Ａの割り込みが長時間禁止されたり、強制的に処理時間を引き伸ばされ
	てしまった場合が考えられます。

	　なお、ＰＣＭ８Ａは過負荷状態になると、出力処理を数回繰り返し、過
	負荷状態が一時的なものであればそのまま出力を継続しますが、過負荷状
	態から回復しない場合には、全チャンネルの出力を強制的に停止します。

	　ただし、過負荷状態になるとノイズが出力されたり、出力の音量が不自
	然に変化してしまう事があるため、過負荷状態での使用はできるだけ避け
	てください。

　６−５　多重割り込みについて

	　ＰＣＭ８Ａの割り込み処理中に更に割り込みを行い、その割り込み処理
	から出力命令を実行することができます。

	　ただし、動作モードの切り替え（多重再生モードと、単音再生モードの
	切り替え）や入力命令（ＩＯＣＳの _ADPCMINP, _ADPCMAIN, _ADPCMLIN）
	は、割込み処理中に実行しないでください。

　６−６　出力停止状態について

	　ＡＤＰＣＭ／ＰＣＭデータのポインタとしてメモリの存在しないアドレ
	スを指定したために、ＰＣＭ８Ａの割り込み処理中にバスエラーを起こし
	た場合や、INTERRUPT スイッチでＰＣＭ８Ａの割り込み処理中に停止させ、
	そのまま割り込み処理から抜けてしまった場合には、ＰＣＭ８Ａ内部の割
	り込み処理フラグが立ったままとなり、出力ができない状態になります。

	　この状態の検出は、割り込み処理以外のプログラムから $FFF0 コール
	（ＰＣＭ８Ａ割り込みフラグチェック）を実行することで確認できます。

	　出力停止状態になっている場合、コマンドラインからは PCM8A CLR と
	入力することで復帰します。
	　また、プログラムで復帰させる場合、スーパーバイザモードで、以下の
	プログラムを実行することで復帰します。

		move.w	sr,-(sp)
		ori.w	#$0700,sr	←割り込み禁止
		moveq	#$F0,d0
		trap	#2		←割り込み処理中フラグチェック
		tst.l	d0
		beq	P8A_OK		←正常なら何もしない
		moveq	#$F1,d0
		trap	#2		←出力が停止しているので内部初期化
	P8A_OK:	move.w	(sp)+,sr	←割り込み許可

　６−７　ＡＤＰＣＭ独占方法

	　ＰＣＭ８ＡがＡＤＰＣＭを管理している時に、一時的にＡＤＰＣＭを独
	占する必要がある場合、ＰＣＭ８Ａを強制的に停止させた後に、$0C32 に
	 $00,$42 以外の値を設定してください。
	　実際の設定値は、出力時には $02,$12,$22、入力時には $04,$14,$24
	のいずれかの値の設定を推奨します。
	（『６−３　システムワーク $0C32 について』を参照）
	　ＡＤＰＣＭの一時的な使用が終了した場合、$0C32 に $00 を設定して
	おけば、ＰＣＭ８Ａに対する出力要求が発生した時点で、ＡＤＰＣＭの管
	理はＰＣＭ８Ａに戻ります。


〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜
７．音量変換の詳細について

	音量変換の詳細情報は以下の通りです。

　　音量設定値	レベル	　dB		ADPCM 倍率	PCM 倍率※

	$40	-64	-53.0		0.0022		0.0024	(5/2048)
	$41	-63	-52.2		0.0025		　↑
	$42	-62	-51.3		0.0027		0.0029	(3/1024)
	$43	-61	-50.5		0.0030		　↑
	$44	-60	-49.7		0.0033		　↑
	$45	-59	-48.8		0.0036		0.0039	(1/256)
	$46	-58	-48.0		0.0040		　↑
	$47	-57	-47.2		0.0044		　↑
	$48	-56	-46.4		0.0048		0.0049	(5/1024)
	$49	-55	-45.5		0.0053		　↑
	$4A	-54	-44.7		0.0058		0.0059	(3/512)
	$4B	-53	-43.9		0.0064		　↑
	$4C	-52	-43.0		0.0070		0.0078	(1/128)
	$4D	-51	-42.2		0.0077		　↑
	$4E	-50	-41.4		0.0085		　↑
	$4F	-49	-40.6		0.0094		0.0098	(5/512)
	$50	-48	-39.7		0.010		　↑
	$51	-47	-38.9		0.011		0.012	(3/256)
	$52	-46	-38.1		0.012		　↑
	$53	-45	-37.3		0.014		　↑
	$54	-44	-36.4		0.015		0.016	(1/64)
	$55	-43	-35.6		0.016		　↑
	$56	-42	-34.8		0.018		　↑
	$57	-41	-33.9		0.020		0.023	(3/128)
	$58	-40	-33.1		0.022		　↑
	$59	-39	-32.3		0.024		　↑
	$5A	-38	-31.5		0.026		　↑
	$5B	-37	-30.6		0.029		0.031	(1/32)
	$5C	-36	-29.8		0.032		　↑
	$5D	-35	-29.0		0.035		0.039	(5/128)
	$5E	-34	-28.1		0.039		　↑
	$5F	-33	-27.3		0.043		0.047	(3/64)
	$60	-32	-26.5		0.047		　↑
	$61	-31	-25.7		0.052		　↑
	$62	-30	-24.8		0.057		0.063	(1/16)
	$63	-29	-24.0		0.063		　↑
	$64	-28	-23.2		0.069		0.078	(5/64)
	$65	-27	-22.3		0.076		　↑
	$66	-26	-21.5		0.084		0.094	(3/32)
	$67	-25	-20.7		0.092		　↑
	$68	-24	-19.9		0.10		　↑
	$69	-23	-19.0		0.11		0.13	(1/8)
	$6A	-22	-18.2		0.12		　↑
	$6B,$00	-21	-17.4		0.13		　↑
	$6C	-20	-16.6		0.15		0.16	(5/32)
	$6D	-19	-15.7		0.16		　↑
	$6E	-18	-14.9		0.18		0.19	(3/16)
	$6F,$01	-17	-14.1		0.20		　↑
	$70	-16	-13.2		0.21		0.25	(1/4)
	$71,$02	-15	-12.4		0.24		　↑
	$72	-14	-11.6		0.26		　↑
	$73	-13	-10.8		0.29		0.31	(5/16)
	$74,$03	-12	-9.9		0.32		　↑
	$75	-11	-9.1		0.35		0.38	(3/8)
	$76,$04	-10	-8.3		0.39		　↑
	$77	-9	-7.5		0.42		　↑
	$78	-8	-6.6		0.47		0.50	(1/2)
	$79,$05	-7	-5.8		0.51		　↑
	$7A	-6	-5.0		0.56		0.63	(5/8)
	$7B,$06	-5	-4.1		0.62		　↑
	$7C	-4	-3.3		0.68		　↑
	$7D,$07	-3	-2.5		0.75		0.75	(3/4)
	$7E	-2	-1.7		0.83		　↑
	$7F	-1	-0.8		0.91		1.00

	$80,$08	 0	 0		1.00		1.00

	$81	+1	+0.8		1.10		1.00
	$82,$09	+2	+1.7		1.21		1.25	(5/4)
	$83	+3	+2.5		1.33		　↑
	$84,$0A	+4	+3.3		1.46		1.50	(3/2)
	$85	+5	+4.1		1.61		　↑
	$86	+6	+5.0		1.77		2.00
	$87,$0B	+7	+5.8		1.95		　↑
	$88	+8	+6.6		2.14		　↑
	$89	+9	+7.5		2.36		2.50	(5/2)
	$8A,$0C	+10	+8.3		2.60		　↑
	$8B	+11	+9.1		2.85		3.00
	$8C,$0D	+12	+9.9		3.14		　↑
	$8D	+13	+10.8		3.46		　↑
	$8E	+14	+11.6		3.80		4.00
	$8F,$0E	+15	+12.4		4.18		　↑
	$90	+16	+13.2		4.61		5.00
	$91,$0F	+17	+14.1		5.06		　↑
	$92	+18	+14.9		5.56		6.00
	$93	+19	+15.7		6.13		　↑
	$94	+20	+16.6		6.75		　↑
	$95	+21	+17.4		7.43		8.00
	$96	+22	+18.2		8,17		　↑
	$97	+23	+19.0		8.97		　↑
	$98	+24	+19.9		9.89		10.00
	$99	+25	+20.7		10.85		　↑
	$9A	+26	+21.5		11.94		12.00
	$9B	+27	+22.3		13.15		　↑
	$9C	+28	+23.2		14.50		16.00
	$9D	+29	+24.0		16.00		　↑
	$9E	+30	+24.8		17.64		　↑
	$9F	+31	+25.7		19.40		20.00
	$A0	+32	+26.5		21.26		　↑

	※８ビットＰＣＭでは $40〜$53 は倍率が 0 になります


〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜〜
